name: Build APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev \
          python3-pip \
          git \
          zip \
          unzip \
          libgl1 \
          libglu1-mesa \
          libsqlite3-dev \
          zlib1g-dev \
          wget \
          curl

    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade cython
        pip install buildozer==1.5.0

    - name: Prepare Android SDK and NDK
      run: |
        mkdir -p ~/.buildozer/android/platform
        cd ~/.buildozer/android/platform
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdtools.zip
        unzip -q cmdtools.zip -d cmdline-tools
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/cmdline-tools/* cmdline-tools/latest/
        export PATH=$PWD/cmdline-tools/latest/bin:$PATH
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        yes | sdkmanager --licenses
        sdkmanager --verbose --no_https \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;30.0.3" \
          "ndk;21.4.7075529"

    - name: Fix sdkmanager path for Buildozer
      run: |
        mkdir -p ~/.buildozer/android/platform/android-sdk/tools/bin
        ln -sf ~/.buildozer/android/platform/cmdline-tools/latest/bin/sdkmanager ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
        ln -sf ~/.buildozer/android/platform/cmdline-tools/latest/bin/android ~/.buildozer/android/platform/android-sdk/tools/bin/android || true

    - name: Add AIDL to PATH
      run: |
        echo "$HOME/.buildozer/android/platform/build-tools/30.0.3" >> $GITHUB_PATH

    - name: Force Buildozer to use correct build-tools
      run: |
        mkdir -p ~/.buildozer/android/platform/android-sdk/build-tools
        cp -r ~/.buildozer/android/platform/build-tools/30.0.3 ~/.buildozer/android/platform/android-sdk/build-tools/
        export PATH=$HOME/.buildozer/android/platform/build-tools/30.0.3:$PATH

    - name: Set environment variables for Buildozer
      run: |
        echo "ANDROIDSDK=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "ANDROIDNDK=$HOME/.buildozer/android/platform/android-ndk-r25b" >> $GITHUB_ENV
        echo "ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV

    - name: Clone python-for-android manually
      run: |
        rm -rf ~/.buildozer/android/platform/python-for-android
        git clone https://github.com/kivy/python-for-android.git ~/.buildozer/android/platform/python-for-android

    - name: Build APK (debug)
      timeout-minutes: 40
      run: |
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: StoreAP-APK
        path: bin/*.apk
